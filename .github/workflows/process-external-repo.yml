# .github/workflows/consolidate-to-markdown-split.yml

name: Consolidate to Split Markdown Files

on:
  workflow_dispatch:
    inputs:
      repo_url:
        description: 'è¦è™•ç†çš„ Public å€‰åº« URL (ä¾‹å¦‚: https://github.com/facebook/docusaurus)'
        required: true
        type: string
      file_extensions:
        description: 'è¦åŒ…å«çš„å‰¯æª”åæ¸…å–® (ç”¨ç©ºæ ¼åˆ†éš”)'
        required: true
        default: '.js .ts .jsx .tsx .py .md .mdx'
        type: string
      output_filename_base:
        description: 'è¼¸å‡ºçš„ Markdown æª”æ¡ˆåŸºç¤åç¨± (ä¸éœ€åŠ  .md æˆ– part)'
        required: true
        default: 'consolidated-docs'
      max_size_mb:
        description: 'æ¯å€‹åˆ†ç‰‡æª”æ¡ˆçš„æœ€å¤§å¤§å° (MB)ã€‚NotebookLM å»ºè­° 5MB ä»¥ä¸‹ã€‚'
        required: true
        default: '4'
        type: string

jobs:
  build-and-split-markdown:
    runs-on: ubuntu-latest
    steps:
      - name: Clone external repository
        run: |
          mkdir external_repo
          cd external_repo
          git clone --depth 1 ${{ github.event.inputs.repo_url }} .

      - name: Consolidate and Split to Markdown files
        run: |
          cd external_repo
          mkdir ../output_parts
          
          MAX_SIZE_BYTES=$((${{ github.event.inputs.max_size_mb }} * 1024 * 1024))
          FILENAME_BASE="${{ github.event.inputs.output_filename_base }}"
          PART_NUMBER=1
          CURRENT_SIZE=0
          
          # ğŸ’¡ å„ªåŒ–ï¼šä½¿ç”¨ Process Substitution (< <(find...)) ä¾†é¿å… pipeline ä¸­çš„ subshell å•é¡Œ
          # é€™èƒ½ç¢ºä¿ PART_NUMBER çš„å€¼åœ¨è¿´åœˆçµæŸå¾Œä¾ç„¶æœ‰æ•ˆã€‚
          while IFS= read -r -d $'\0' file; do
            should_include=false
            for ext in ${{ github.event.inputs.file_extensions }}; do
              if [[ "$file" == *"$ext" ]]; then
                should_include=true
                break
              fi
            done
            
            if [ "$should_include" = true ]; then
              FILE_SIZE=$(stat -c%s "$file")

              if (( CURRENT_SIZE + FILE_SIZE > MAX_SIZE_BYTES && CURRENT_SIZE > 0 )); then
                PART_NUMBER=$((PART_NUMBER + 1))
                CURRENT_SIZE=0
              fi
              
              OUTPUT_FILE="../output_parts/${FILENAME_BASE}_part_${PART_NUMBER}.md"
              
              if [ $CURRENT_SIZE -eq 0 ]; then
                # ğŸ”¥ ä¿®æ­£ï¼šç‚ºæ‰€æœ‰é‡æ–°å°å‘åŠ ä¸Šé›™å¼•è™Ÿ
                echo "# ${FILENAME_BASE} (Part ${PART_NUMBER})" > "${OUTPUT_FILE}"
                echo "ä¾†æºå€‰åº«: <${{ github.event.inputs.repo_url }}>" >> "${OUTPUT_FILE}"
                echo "***" >> "${OUTPUT_FILE}"
              fi

              # ğŸ”¥ ä¿®æ­£ï¼šç‚ºæ‰€æœ‰é‡æ–°å°å‘åŠ ä¸Šé›™å¼•è™Ÿ
              echo -e "\n\n## æª”æ¡ˆ: \`${file}\`" >> "${OUTPUT_FILE}"

              if [[ "$file" == *.md || "$file" == *.markdown || "$file" == *.mdx ]]; then
                echo -e "\n" >> "${OUTPUT_FILE}"
                # ğŸ”¥ ä¿®æ­£ï¼šç‚ºæ‰€æœ‰é‡æ–°å°å‘åŠ ä¸Šé›™å¼•è™Ÿ
                cat "${file}" >> "${OUTPUT_FILE}"
              else
                lang="${file##*.}"
                echo -e "\n\`\`\`${lang}" >> "${OUTPUT_FILE}"
                # ğŸ”¥ ä¿®æ­£ï¼šç‚ºæ‰€æœ‰é‡æ–°å°å‘åŠ ä¸Šé›™å¼•è™Ÿ
                cat "${file}" >> "${OUTPUT_FILE}"
                echo -e "\n\`\`\`" >> "${OUTPUT_FILE}"
              fi
              
              # ğŸ”¥ ä¿®æ­£ï¼šç‚ºæ‰€æœ‰è®Šæ•¸ä½¿ç”¨åŠ ä¸Šé›™å¼•è™Ÿ
              CURRENT_SIZE=$(stat -c%s "${OUTPUT_FILE}")
            fi
          done < <(find . -type f -print0) # ğŸ’¡ å„ªåŒ–ï¼šfind çš„è¼¸å‡ºå¾é€™è£¡å°å…¥è¿´åœˆ
          
          echo "Splitting complete. Generated ${PART_NUMBER} parts with base name '${FILENAME_BASE}'."

      - name: Upload all Markdown parts as a single artifact
        uses: actions/upload-artifact@v4
        with:
          name: markdown-parts-for-${{ github.event.inputs.output_filename_base }}
          path: output_parts/
